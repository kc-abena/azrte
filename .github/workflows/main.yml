name: Manual Azure OIDC Token Exchange

on:
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  azure-token-exchange:
    runs-on: ubuntu-latest

    steps:
      - name: Get GitHub OIDC Token via GitHub Script
        id: oidc
        uses: actions/github-script@v7
        with:
          script: |
            const tokenRequestUrl = process.env.ACTIONS_ID_TOKEN_REQUEST_URL + "&audience=api://AzureADTokenExchange";
            const tokenRequestToken = process.env.ACTIONS_ID_TOKEN_REQUEST_TOKEN;

            const res = await fetch(tokenRequestUrl, {
              headers: {
                Authorization: `bearer ${tokenRequestToken}`,
              },
            });

            if (!res.ok) {
              throw new Error(`Failed to get OIDC token: ${res.status} ${res.statusText}`);
            }

            const data = await res.json();
            core.setSecret(data.value);
            core.setOutput("oidc_token", data.value);

      - name: Exchange OIDC Token for ARM and Graph Tokens
        id: tokens
        run: |
          TENANT_ID="${{ secrets.AZURE_TENANT_ID }}"
          CLIENT_ID="${{ secrets.AZURE_CLIENT_ID }}"
          OIDC_TOKEN="${{ steps.oidc.outputs.oidc_token }}"

          echo "ðŸ” Requesting ARM token..."
          ARM_RESPONSE=$(curl -s -X POST -H "Content-Type: application/x-www-form-urlencoded" \
            -d "client_id=$CLIENT_ID" \
            -d "grant_type=urn:ietf:params:oauth:grant-type:jwt-bearer" \
            -d "client_assertion_type=urn:ietf:params:oauth:client-assertion-type:jwt-bearer" \
            -d "client_assertion=$OIDC_TOKEN" \
            -d "scope=https://management.azure.com/.default" \
            -d "requested_token_use=on_behalf_of" \
            "https://login.microsoftonline.com/$TENANT_ID/oauth2/v2.0/token")

          ARM_TOKEN=$(echo "$ARM_RESPONSE" | jq -r '.access_token')
          echo "::add-mask::$ARM_TOKEN"
          echo "arm_token=$ARM_TOKEN" >> $GITHUB
